---
import { Image } from 'astro:assets';
import Icon4 from '../../images/icon-4.png';
import Icon5 from '../../images/icon-5.png';
import Icon6 from '../../images/icon-6.png';

import type { GetStaticPaths } from 'astro';
import MainLayout from '@layouts/MainLayout.astro';
import { innovationCatalog } from '~/jsons/innovation-list';
import BasicButton from '~/components/shared/button/BasicButton/BasicButton.component.astro';
import SocialShare from '~/components/shared/SocialShare/SocialShare.component.astro';
import Input from '~/components/shared/input/Input.astro';
import DownloadImage from '~/components/shared/DownloadImage/DownloadImage.component.astro';
import type { Innovation as InnovationComplete } from '~/interfaces/search-complete.interface';
import { getCountryTextStructured } from '~/utils/country-normalize-text/getCountryNormalizeText';
import getReadinessScaleText from '~/utils/readiness-scale/getReadinessScaleText';
import PDFLink from '~/components/shared/PDFLink/PDFLink.component.astro';
import { useApi } from '~/composables/useApi';

interface staticPaths {
  params: { id: string };
  props: { innovation: InnovationComplete };
}

const stats = [
  {
    title: 'Geoscope',
    value: 32,
    imagePath: Icon4,
    quality: 'max'
  },
  {
    title: 'Innovation typology',
    value: 25,
    imagePath: Icon5,
    quality: 'max'
  },
  {
    title: 'Scaling readiness',
    value: 7,
    imagePath: Icon6,
    quality: 'max'
  }
];

(globalThis as any).__innovationCache ??= null;

export const getStaticPaths = (async () => {
  console.log('Building static paths for innovations...');

  // Helper function to fetch innovations with complete data from API at build time
  async function fetchInnovationsComplete(): Promise<InnovationComplete[] | null> {
    try {
      // Use full API URL for build-time fetching (SSG), since no proxy is available during build
      const { getInnovationsComplete } = useApi();
      const response = await getInnovationsComplete({
        phase: '428',
        limit: 1000
      });
      return response.innovations;
    } catch (error) {
      console.warn('Build: API fetch failed, falling back to static data:', error);
      return null;
    }
  }

  // Return cached data if available
  if ((globalThis as any).__innovationCache) {
    console.log('Using cached static paths for innovations');
    return (globalThis as any).__innovationCache;
  }

  try {
    // Try to fetch from API first
    const apiData = await fetchInnovationsComplete();

    if (apiData && apiData.length > 0) {
      console.log(`Building paths from API data: ${apiData.length} innovations`);

      // Log the innovation IDs we're processing
      console.log(
        'Innovation IDs being processed:',
        apiData.map(i => i.projectInnovationId)
      );

      // Create paths directly from complete innovation data (no mapping needed)
      const paths = apiData.map(innovation => {
        console.log(`Building path for innovation ID: ${innovation.projectInnovationId}`);

        return {
          params: { id: innovation.projectInnovationId.toString() },
          props: {
            innovation
          }
        };
      });

      console.log(`Successfully generated ${paths.length} paths`);
      console.log(
        'Generated path IDs:',
        paths.map(p => p.params.id)
      );

      (globalThis as any).__innovationCache = paths; // Cache the successful paths

      return paths;
    }
  } catch (error) {
    console.warn('Failed to fetch from API during build, falling back to static data:', error);
  }

  // Fallback to static data
  return innovationCatalog.flatMap(innovation => ({
    params: { id: innovation.id.toString() },
    props: { innovation }
  }));
}) satisfies GetStaticPaths;

interface Props {
  innovation: InnovationComplete;
}

const { innovation } = Astro.props;

console.log('Innovation', innovation);

// Add debugging for country data
console.log('Innovation countries:', innovation.countries);
console.log('Innovation regions:', innovation.regions);
if (innovation.countries) {
  console.log('Country text result:', getCountryTextStructured(innovation.countries, innovation.regions || [], true));
}

const countryText = getCountryTextStructured(innovation.countries, innovation.regions, true);
---

<MainLayout title={innovation.title} description={innovation.narrative}>
  <article class="container mx-auto m-auto my-auto p-0 xl:px-16 2xl:px-20">
    <!-- Return link -->
    <a href="/" class="my-12 mb-8 text-primary-300 text-sm font-semibold flex items-center gap-2 text-xs xl:text-sm 2xl:text-base hover:underline">
      <span class="pi pi-arrow-left"></span>
      <p>Go back to innovations catalog</p>
    </a>

    <!-- Title and main options -->
    <section class="max-width">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-2.5">
        <h1 class="text-base xl:text-lg 2xl:text-xl font-bold mb-4 flex-1 min-w-0">{innovation.title}</h1>
        <div class="flex flex-wrap gap-2 flex-shrink-0">
          <!--           <BasicButton hasIcon icon="pi pi-bookmark" classList={'bg-white-100 text-primary-300 border border-border-light px-3 py-1 rounded'} /> -->
          <PDFLink id={innovation.projectInnovationId.toString()} isJustIcon className="!border-border-light px-3 py-1 rounded mb-0 !w-[36px]" />
          <SocialShare title={innovation.title} isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
          <DownloadImage isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
        </div>
      </div>
      <p class="text-sm xl:text-base 2xl:text-lg font-[400] mb-6 text-text-600 text-justify">{innovation.narrative}</p>
    </section>

    <!-- Main Content -->
    <div class="grid grid-cols-4 gap-4 mb-12">
      <section class="col-span-3">
        <!-- Key Metrics -->
        <div class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300">Key metrics</p>
          <div class="flex flex-wrap gap-24 mt-4 justify-between px-12 xs:px-2 sm:px-4">
            <!-- Geoscope -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[0].quality} src={stats[0].imagePath} alt={stats[0].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Geoscope</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">
                {
                  countryText.hasMore ? (
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{countryText.text}</span>
                    <em>{countryText.additionalText}</em>
                  ) : (
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{countryText.text}</span>
                  )
                }
              </span>
            </div>
            <!-- Typology -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[1].quality} src={stats[1].imagePath} alt={stats[1].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Innovation typology</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal w-[75%]">{innovation.innovationType?.name || 'N/A'}</span>
            </div>
            <!-- Scaling Readiness -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[2].quality} src={stats[2].imagePath} alt={stats[2].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Scaling readiness</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal"
                >{getReadinessScaleText(innovation.readinessScale).textComplet}</span
              >
            </div>
          </div>
        </div>
        <!-- Description -->
        <div class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300">
          <!-- Expected outcomes -->
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300">Expected outcomes</p>
            <p class="text-xs xl:text-sm 2xl:text-base text-text-900 font-normal mt-2 text-justify">
            {
              innovation.knowledgeResultsNarrative == null || innovation.knowledgeResultsNarrative === '' ? (
              <span class="text-gray-500">No Information available yet</span>
              ) : (
              innovation.knowledgeResultsNarrative
              )
            }
            </p>
          <!-- Intended beneficiaries/users -->
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mt-4">Intended beneficiaries/users</p>
          <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal mt-2 text-justify">
            {
              innovation.beneficiariesNarrative == null || innovation.beneficiariesNarrative === '' ? (
                <span class="text-gray-500">No Information available yet</span>
              ) : (
                innovation.beneficiariesNarrative
              )
            }
          </p>
          <!-- Bundle innovations -->
          {innovation.bundles != null && innovation.bundles.length > 0 && (
          <>
            <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mt-4">Bundle innovations</p>
            <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal mt-2">
            {innovation.bundles.map(bundle => (
              <div class="inline-flex items-center gap-1 border-1 border-[#439255] bg-[#F7F7F7] rounded-full px-2 text-[#439255]">
              {
                bundle.selectedInnovationReadinessScale == null ? (
                <svg height="10" viewBox="0 0 15 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M2.2557 7.24802C2.06283 7.40936 1.80123 7.5 1.52847 7.5C1.2557 7.5 0.994106 7.40936 0.801231 7.24802C0.608356 7.08668 0.5 6.86785 0.5 6.63968C0.5 6.41151 0.608356 6.19269 0.801231 6.03135L4.22721 3.16636L4.2344 3.16034C4.51432 2.93101 4.89053 2.80256 5.28234 2.80256C5.67416 2.80256 6.05037 2.93101 6.33028 3.16034L6.33748 3.16636L8.08593 4.62895L10.4984 2.49483L9.42939 1.60059C9.32171 1.51041 9.2484 1.39555 9.21871 1.27053C9.18902 1.14551 9.20428 1.01594 9.26258 0.898171C9.32087 0.780405 9.41957 0.67973 9.54623 0.608862C9.67288 0.537994 9.8218 0.500112 9.97417 0.5H13.7291C13.9335 0.5 14.1296 0.567942 14.2742 0.688881C14.4188 0.809819 14.5 0.973847 14.5 1.14488V4.28501C14.4999 4.41247 14.4546 4.53705 14.3699 4.64299C14.2851 4.74894 14.1648 4.83151 14.024 4.88027C13.8832 4.92903 13.7283 4.9418 13.5789 4.91696C13.4294 4.89213 13.2921 4.8308 13.1843 4.74073L11.9529 3.71064L9.17344 6.17064L9.14569 6.19386C8.86577 6.42319 8.48956 6.55164 8.09775 6.55164C7.70594 6.55164 7.32973 6.42319 7.04981 6.19386L7.04262 6.18784L5.28183 4.71579L2.2557 7.24802Z"
                  fill="#439255" />
                </svg>
                <span class="text-sm">{bundle.selectedInnovationReadinessScale - 1}</span>
                ) : <span class="text-sm">Internal</span>
              }
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{bundle.selectedInnovationName}</span>
              </div>
            ))}
            </p>
          </>
          )}
          <!-- Piece of evidence -->
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mt-4">Piece of evidence</p>
          <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal mt-2">
            {
              innovation.references == null || innovation.references.length === 0 ? (
                <span class="text-gray-500">No Information available yet</span>
              ) : (
                <ul class="pl-4">
                  {
                  innovation.references.map(reference => 
                    reference.hasEvidenceByDeliverable ? (
                      <li class="py-1 list-disc">
                        <p class="text-sm font-normal">{reference.deliverableName ? reference.deliverableName : "No Deliverable Name"}</p>
                        <a class="text-xs text-text-500 underline text-primary-500 font-semibold" href={reference.disseminationUrl ? reference.disseminationUrl : "#"}>{reference.disseminationUrl ? reference.disseminationUrl : "No Link Available"}</a>
                      </li>
                    ) : (
                      <li class="py-1 list-disc">
                        <p class="text-sm font-normal">{reference.reference ? reference.reference : "No Reference Name"}</p>
                        <a class="text-xs text-text-500 underline text-primary-500 font-semibold" href={reference.link ? reference.link : "#"}>{reference.link ? reference.link : "No Link Available"}</a>
                      </li>
                    )
                  )
                }
                </ul>
              )
            }
          </p>
        </div>
        <!-- Community solution stories -->
        <section class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300 relative">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Community solution stories</p>

                    <!-- Comment stories -->
          <div class="grid grid-cols-1 gap-4 mt-4">
            {
              /* Note: comments property doesn't exist in InnovationDetail interface, using placeholder */
              [].map((story: any, index: number) => (
                <div class="border-l-primary-400 border border-border-light border-l-4 w-full p-4 hover:shadow-lg transition-shadow duration-300">
                  <div class="flex items-center mb-2 gap-2">
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-semibold">{story.author}</span>
                    <span class="w-[2px] h-[2px] rounded-full bg-text-800" />
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-500 font-normal">{story.date}</span>
                  </div>
                  <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{story.text}</p>
                </div>
              ))
            }
            {/* Show message when no comments are available */}
            <div class="text-center py-4 text-gray-500">
              <p class="text-sm">No community stories available yet. Be the first to share your experience!</p>
            </div>
          </div>

          <!-- Input container -->
          <form class="mt-6" id="community-story-form">
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Share your experience with this innovation or read what others have accomplished:</p>
            <!-- Content Form -->
            <div class="mt-2 ml-4 flex flex-col gap-1">
              <!-- Name Input -->
              <Input
                label="Name:"
                placeholder="Enter your name"
                id="name-input"
                name="name-input"
                required
              />
              <!-- E-mail Input -->
              <Input
                label="E-mail:"
                placeholder="Enter your e-mail"
                id="email-input"
                name="email-input"
                type="email"
                required
              />
              <!-- Comment Input -->
               <Input
                label="Comment:"
                placeholder="Share your experience..."
                id="story-input"
                name="story-input"
                hasMaxLength
                maxLength={50}
                required
              />
              <!-- Submit Button with reCAPTCHA -->
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end mt-4">
                
                <BasicButton 
                  text='Send' 
                  type="submit" 
                  classList="!bg-lime-500 text-white px-10 py-3 rounded hover:!bg-lime-800 transition-colors duration-300" 
                />
            </div>
          </form>

          <!-- Blur overlay with under construction message -->
<!--           <div class="absolute inset-0 backdrop-blur-sm bg-white/30 flex items-center justify-center rounded-xl">
            <div class="bg-white border-2 border-yellow-400 rounded-lg p-6 shadow-lg text-center">
              <div class="text-yellow-500 text-3xl mb-2">ðŸš§</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Under Construction</h3>
              <p class="text-sm text-gray-600">This feature is currently being developed and will be available soon.</p>
            </div>
          </div> -->
        </section>
      </section>
      <aside class="col-span-1">
        <!-- Download PDF button -->
        <PDFLink id={innovation.projectInnovationId.toString()} className="w-full mb-6" />
        <!-- Quick Information -->
        <div class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Quick information</p>

          <div class="mb-4">
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Lead organization(s)</p>
            {
              innovation.contactPersons && innovation.contactPersons.length > 0 ? (
                <p class="text-xs xl:text-sm 2xl:text-base text-gray-600 font-normal">{innovation.contactPersons[0].institutionAcronym ? innovation.contactPersons[0].institutionAcronym + ' - ' : ''}{innovation.contactPersons[0].institutionName}</p>
              ) : (
                <p class="text-xs xl:text-sm 2xl:text-base text-gray-600 font-normal">This is yet to be determined.</p>
              )
            }
          </div>
          <!-- Key actors -->
          <div class="mb-4">
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Key actors</p>
            <ul class="pl-2">
              {
                innovation.actors && innovation.actors.length > 0 ? (
                  innovation.actors.map(actor => (
                    <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside break-all">{actor.actorInfo?.name || 'Unknown Actor'}</li>
                  ))
                ) : (
                  <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">This is yet to be determined.</li>
                )
              }
            </ul>
          </div>
          <!-- Key organizations -->
          <div>
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Key organizations</p>
            <ul class="pl-2">
              {
                innovation.contributingOrganizations && innovation.contributingOrganizations.length > 0 ? (
                  innovation.contributingOrganizations.map(org => (
                    <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">{org.institutionAcronym ? org.institutionAcronym + ' - ' : ''}{org.institutionName}</li>
                  ))
                ) : (
                  <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">No organizations available</li>
                )
              }
            </ul>
          </div>
        </div>
        <!-- Contact information -->
        <div class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-2">Contact information</p>

          <div class="mb-2">
            <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">Get in touch with the responsible team</p>
            <ul class="pl-2">
              {
                innovation.contactPersons && innovation.contactPersons.length > 0 ? (
                  innovation.contactPersons.map(contact =>
                    contact.contactPersons && contact.contactPersons.length > 0 ? (
                      contact.contactPersons.map(person => (
                        <>
                          <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">
                            {person.userName} -{' '}
                            <a class="underline" href={`mailto:${person.userEmail}`}>
                              {person.userEmail}
                            </a>
                          </li>
                        </>
                      ))
                    ) : (
                      <span>No contact persons available</span>
                    )
                  )
                ) : (
                  <span>No contact persons available</span>
                )
              }
            </ul>
            <div class="mt-2">
              <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Technical Support</p>
              <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">
                This information comes from the Knowledge and Data Sharing system MARLO, to any question please contact the support team
              </p>
              <a
                href="mailto:MARLOSupport@cgiar.org"
                class="text-[11px] xl:text-sm 2xl:text-base text-black underline hover:underline break-all">MARLOSupport@cgiar.org</a
              >
            </div>
          </div>
        </div>
        <!-- Share -->
        <div class="w-full p-4 mb-6 border border-border-light rounded-xl bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Share</p>
          <!--           <BasicButton
            text="Save to favorites"
            hasIcon
            icon="pi pi-bookmark"
            classList={'w-full justify-center border-primary-300 text-primary-300 mb-2 hover:bg-primary-300 '}
          /> -->
          <div class="mb-2">
            <SocialShare title={innovation.title} className="!mb-0" />
          </div>
          <DownloadImage />
        </div>
      </aside>
    </div>
  </article>
</MainLayout>

<script define:vars={{ innovationId: innovation.projectInnovationId }}>

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('community-story-form');

    if(!form) return;

    form.addEventListener('submit', function (event) {
      event.preventDefault();
      event.stopPropagation();

      const formData = new FormData(form);
      const name = formData.get('name-input');
      const email = formData.get('email-input');
      const story = formData.get('story-input');
      
      const commentData = {
        user_name: name,
        user_email: email,
        comment: story,
        innovation_id: innovationId.toString()
      };

      console.log('Submitting comment data:', commentData);
      alert('Thank you for sharing your experience! This feature is under development.');
      form.reset();
    });
  });
</script>