---
import { Image } from 'astro:assets';
import Icon4 from '../../images/icon-4.png';
import Icon5 from '../../images/icon-5.png';
import Icon6 from '../../images/icon-6.png';

import type { GetStaticPaths } from 'astro';
import MainLayout from '@layouts/MainLayout.astro';
import { innovationCatalog } from '~/jsons/innovation-list';
import BasicButton from '~/components/shared/button/BasicButton/BasicButton.component.astro';
import SocialShare from '~/components/shared/SocialShare/SocialShare.component.astro';
import Input from '~/components/shared/input/Input.astro';
import DownloadImage from '~/components/shared/DownloadImage/DownloadImage.component.astro';
import type { InnovationDetail } from '~/interfaces/innovation-catalog-v2.interface';
import type { Innovation as InnovationComplete } from '~/interfaces/search-complete.interface';
import { getCountryTextStructured } from '~/utils/country-normalize-text/getCountryNormalizeText';
import getReadinessScaleText from '~/utils/readiness-scale/getReadinessScaleText';
import PDFLink from '~/components/shared/PDFLink/PDFLink.component.astro';

interface staticPaths {
  params: { id: string };
  props: { innovation: InnovationDetail };
}

const stats = [
  {
    title: 'Geoscope',
    value: 32,
    imagePath: Icon4,
    quality: 'max'
  },
  {
    title: 'Innovation typology',
    value: 25,
    imagePath: Icon5,
    quality: 'max'
  },
  {
    title: 'Scaling readiness',
    value: 7,
    imagePath: Icon6,
    quality: 'max'
  }
];

(globalThis as any).__innovationCache ??= null;

export const getStaticPaths = (async () => {
  console.log('Building static paths for innovations...');

  // Helper function to fetch innovations with complete data from API at build time
  async function fetchInnovationsComplete(): Promise<InnovationComplete[] | null> {
    try {
      // Use full API URL for build-time fetching (SSG), since no proxy is available during build
      const baseApiUrl = import.meta.env.PUBLIC_API;
      const apiUrl = `${baseApiUrl}/innovations/search-complete?phase=428&limit=1000`;

      const response = await fetch(apiUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        console.warn(`API request failed with status: ${response.status}. Falling back to static data.`);
        return null;
      }

      const data = await response.json();
      console.log(`Build: Successfully fetched ${data.innovations?.length || 0} innovations from API`);
      return data.innovations;
    } catch (error) {
      console.warn('Build: API fetch failed, falling back to static data:', error);
      return null;
    }
  }

  // Return cached data if available
  if ((globalThis as any).__innovationCache) {
    console.log('Using cached static paths for innovations');
    return (globalThis as any).__innovationCache;
  }

  try {
    // Try to fetch from API first
    const apiData = await fetchInnovationsComplete();

    if (apiData && apiData.length > 0) {
      console.log(`Building paths from API data: ${apiData.length} innovations`);

      // Log the innovation IDs we're processing
      console.log(
        'Innovation IDs being processed:',
        apiData.map(i => i.projectInnovationId)
      );

      // Create paths directly from complete innovation data
      const paths = apiData.map(innovation => {
        console.log(`Building path for innovation ID: ${innovation.projectInnovationId}`);

        // Map Innovation (search-complete) to InnovationDetail
        const mappedInnovation: InnovationDetail = {
          id: innovation.id,
          projectInnovationId: innovation.projectInnovationId,
          idPhase: innovation.idPhase,
          year: innovation.year,
          title: innovation.title,
          narrative: innovation.narrative,
          phaseResearchId: innovation.phaseResearchId,
          stageInnovationId: innovation.stageInnovationId,
          geographicScopeId: innovation.geographicScopeId,
          innovationTypeId: innovation.innovationType?.id || 0,
          repIndRegionId: innovation.repIndRegionId,
          repIndContributionCrpId: innovation.repIndContributionCrpId,
          repIndDegreeInnovationId: innovation.repIndDegreeInnovationId,
          projectExpectedStudiesId: innovation.projectExpectedStudiesId,
          descriptionStage: innovation.descriptionStage || '',
          evidenceLink: innovation.evidenceLink || '',
          genderFocusLevelId: innovation.genderFocusLevelId,
          genderExplanation: innovation.genderExplanation || '',
          youthFocusLevelId: innovation.youthFocusLevelId,
          youthExplanation: innovation.youthExplanation || '',
          leadOrganizationId: innovation.leadOrganizationId,
          adaptativeResearchNarrative: innovation.adaptativeResearchNarrative,
          isClearLead: innovation.isClearLead || false,
          otherInnovationType: innovation.otherInnovationType || null,
          externalLink: innovation.externalLink,
          numberOfInnovations: innovation.numberOfInnovations,
          hasMilestones: innovation.hasMilestones || null,
          shortTitle: innovation.shortTitle || innovation.title,
          innovationNatureId: innovation.innovationNatureId,
          hasCgiarContribution: innovation.hasCgiarContribution || null,
          reasonNotCgiarContribution: innovation.reasonNotCgiarContribution,
          beneficiariesNarrative: innovation.beneficiariesNarrative || '',
          intellectualPropertyInstitutionId: innovation.intellectualPropertyInstitutionId || null,
          hasLegalRestrictions: innovation.hasLegalRestrictions || null,
          hasAssetPotential: innovation.hasAssetPotential || null,
          hasFurtherDevelopment: innovation.hasFurtherDevelopment || null,
          otherIntellectualProperty: innovation.otherIntellectualProperty || '',
          innovationImportance: innovation.innovationImportance || '',
          readinessScale: innovation.readinessScale || 0,
          readinessReason: innovation.readinessReason || '',
          genderScoreId: innovation.genderScoreId || 0,
          climateChangeScoreId: innovation.climateChangeScoreId || 0,
          foodSecurityScoreId: innovation.foodSecurityScoreId || 0,
          environmentalScoreId: innovation.environmentalScoreId || 0,
          povertyJobsScoreId: innovation.povertyJobsScoreId || 0,
          knowledgeResultsNarrative: innovation.knowledgeResultsNarrative || '',
          phase: innovation.phase,
          innovationStage: innovation.innovationStage,
          geographicScope: innovation.geographicScope,
          innovationType: innovation.innovationType || { id: 0, name: 'Unknown', isOldType: false },
          region: innovation.region,
          contributionCrp: innovation.contributionCrp,
          degreeInnovation: innovation.degreeInnovation,
          leadOrganization: innovation.leadOrganization,
          genderFocusLevel: innovation.genderFocusLevel,
          youthFocusLevel: innovation.youthFocusLevel,
          intellectualPropertyInstitution: innovation.intellectualPropertyInstitution || null,
          phaseResearch: innovation.phaseResearch,
          projectId: innovation.projectId,
          isActive: innovation.isActive,
          activeSince: new Date(innovation.activeSince),
          createdBy: innovation.createdBy,
          modifiedBy: innovation.modifiedBy,
          modificationJustification: innovation.modificationJustification,
          actors: innovation.actors.map(actor => ({
            ...actor,
            activeSince: new Date(actor.activeSince)
          })),
          sdgs: innovation.sdgs || [],
          regions: innovation.regions.map(region => ({
            ...region,
            name: region.regionName
          })),
          countries: innovation.countries.map(country => ({
            ...country,
            name: country.countryName
          })),
          organizations: innovation.organizations || [],
          externalPartners: innovation.contactPersons.map(cp => ({
            id: cp.id,
            projectInnovationId: cp.projectInnovationId,
            institutionId: cp.institutionId,
            institutionName: cp.institutionName,
            institutionAcronym: cp.institutionAcronym || '',
            institutionWebsite: cp.institutionWebsite || '',
            idPhase: cp.idPhase,
            innovationPartnerTypeId: cp.innovationPartnerTypeId,
            partnerTypeName: cp.partnerTypeName,
            isActive: cp.isActive,
            activeSince: new Date(cp.activeSince),
            contactPersons: cp.contactPersons.map(person => ({
              id: person.id,
              partnershipId: person.partnershipId,
              userId: person.userId,
              userName: person.userName,
              userEmail: person.userEmail,
              isActive: person.isActive,
              activeSince: new Date(person.activeSince)
            }))
          })),
          contributingOrganizations: innovation.contributingOrganizations || []
        };

        return {
          params: { id: innovation.projectInnovationId.toString() },
          props: {
            innovation: mappedInnovation
          }
        };
      });

      console.log(`Successfully generated ${paths.length} paths`);
      console.log(
        'Generated path IDs:',
        paths.map(p => p.params.id)
      );

      (globalThis as any).__innovationCache = paths; // Cache the successful paths

      return paths;
    }
  } catch (error) {
    console.warn('Failed to fetch from API during build, falling back to static data:', error);
  }

  // Fallback to static data
  return innovationCatalog.flatMap(innovation => ({
    params: { id: innovation.id.toString() },
    props: { innovation }
  }));
}) satisfies GetStaticPaths;

interface Props {
  innovation: InnovationDetail;
}

const { innovation } = Astro.props;

// Add debugging for country data
console.log('Innovation countries:', innovation.countries);
console.log('Innovation regions:', innovation.regions);
if (innovation.countries) {
  console.log('Country text result:', getCountryTextStructured(innovation.countries, innovation.regions || [], true));
}
---

<MainLayout title={innovation.title} description={innovation.narrative}>
  <article class="container mx-auto m-auto my-auto p-0 xl:p-16 2xl:p-20">
    <!-- Return link -->
    <a href="/" class="my-12 mb-8 text-primary-300 text-sm font-semibold flex items-center gap-2 text-xs xl:text-sm 2xl:text-base hover:underline">
      <span class="pi pi-arrow-left"></span>
      <p>Go back to innovations catalog</p>
    </a>

    <!-- Title and main options -->
    <section class="max-width">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-2.5">
        <h1 class="text-base xl:text-lg 2xl:text-xl font-bold mb-4 flex-1 min-w-0">{innovation.title}</h1>
        <div class="flex flex-wrap gap-2 flex-shrink-0">
          <BasicButton hasIcon icon="pi pi-bookmark" classList={'bg-white-100 text-primary-300 border border-border-light px-3 py-1 rounded'} />
          <PDFLink id={innovation.projectInnovationId.toString()} isJustIcon className="!border-border-light px-3 py-1 rounded mb-0 !w-[36px]" />
          <SocialShare title={innovation.title} isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
          <DownloadImage isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
        </div>
      </div>
      <p class="text-base xl:text-lg 2xl:text-xl font-normal text-text-600 mb-6">{innovation.narrative}</p>
    </section>

    <!-- Main Content -->
    <div class="grid grid-cols-4 gap-4">
      <section class="col-span-3">
        <!-- Key Metrics -->
        <div class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300">Key metrics</p>
          <div class="flex flex-wrap gap-24 mt-4 justify-center">
            <!-- Geoscope -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[0].quality} src={stats[0].imagePath} alt={stats[0].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Geoscope</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal"
                >{getCountryTextStructured(innovation.countries, innovation.regions, true).text}
                <em>{getCountryTextStructured(innovation.countries, innovation.regions, true).additionalText}</em>
              </span>
            </div>
            <!-- Typology -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[1].quality} src={stats[1].imagePath} alt={stats[1].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Innovation typology</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{innovation.innovationType.name}</span>
            </div>
            <!-- Scaling Readiness -->
            <div class="flex flex-col text-center items-center">
              <div class="w-[40px] h-[40px] mb-1 flex items-center justify-center">
                {(<Image height="32" quality={stats[2].quality} src={stats[2].imagePath} alt={stats[2].title} class={'pb-1'} />)}
              </div>
              <span class="text-[10px] xl:text-xs 2xl:text-sm text-primary-300 font-bold">Scaling readiness</span>
              <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal"
                >{getReadinessScaleText(innovation.readinessScale).textComplet}</span
              >
            </div>
          </div>
        </div>
        <!-- Description -->
        <div class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300">Expected outcomes</p>
          <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal mt-4">
            {
              innovation.knowledgeResultsNarrative == null || innovation.knowledgeResultsNarrative === '' ? (
                <span class="text-gray-500">No expected outcomes available</span>
              ) : (
                innovation.knowledgeResultsNarrative
              )
            }
          </p>
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mt-6">Intended beneficiaries/users</p>
          <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal mt-4">
            {
              innovation.beneficiariesNarrative == null || innovation.beneficiariesNarrative === '' ? (
                <span class="text-gray-500">No intended beneficiaries/users available</span>
              ) : (
                innovation.beneficiariesNarrative
              )
            }
          </p>
        </div>
        <!-- Community solution stories -->
        <section class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300 relative">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Community solution stories</p>

          <!-- Input container -->
          <Input
            label="Share your experience with this innovation or read what others have accomplished."
            placeholder="Share your story..."
            id="story-input"
            name="story-input"
            maxLength={30}
            hasBtnIcon
            btnIcon="majesticons--comment"
          />
          <!-- Comment stories -->
          <div class="grid grid-cols-1 gap-4 mt-4">
            {
              /* Note: comments property doesn't exist in InnovationDetail interface, using placeholder */
              [].map((story: any, index: number) => (
                <div class="border-l-primary-400 border border-border-light border-l-4 w-full p-4 hover:shadow-lg transition-shadow duration-300">
                  <div class="flex items-center mb-2 gap-2">
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-semibold">{story.author}</span>
                    <span class="w-[2px] h-[2px] rounded-full bg-text-800" />
                    <span class="text-xs xl:text-sm 2xl:text-base text-text-500 font-normal">{story.date}</span>
                  </div>
                  <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{story.text}</p>
                </div>
              ))
            }
            {/* Show message when no comments are available */}
            <div class="text-center py-4 text-gray-500">
              <p class="text-sm">No community stories available yet. Be the first to share your experience!</p>
            </div>
          </div>

          <!-- Blur overlay with under construction message -->
          <div class="absolute inset-0 backdrop-blur-sm bg-white/30 flex items-center justify-center rounded">
            <div class="bg-white border-2 border-yellow-400 rounded-lg p-6 shadow-lg text-center">
              <div class="text-yellow-500 text-3xl mb-2">ðŸš§</div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2">Under Construction</h3>
              <p class="text-sm text-gray-600">This feature is currently being developed and will be available soon.</p>
            </div>
          </div>
        </section>
      </section>
      <aside class="col-span-1">
        <!-- Download PDF button -->
        <PDFLink id={innovation.projectInnovationId.toString()} className="w-full mb-6" />
        <!-- Quick Information -->
        <div class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Quick information</p>

          <div class="mb-4">
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Key actors</p>
            {
              innovation.externalPartners && innovation.externalPartners.length > 0 ? (
                <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">{innovation.externalPartners[0].institutionName}</p>
              ) : (
                <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">No key actors available</p>
              )
            }
          </div>
          <div>
            <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Involved organizations</p>
            <ul class="pl-2">
              {
                innovation.contributingOrganizations && innovation.contributingOrganizations.length > 0 ? (
                  innovation.contributingOrganizations.map(org => (
                    <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">{org.institutionName}</li>
                  ))
                ) : (
                  <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">No organizations available</li>
                )
              }
            </ul>
          </div>
        </div>
        <!-- Contact information -->
        <div class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Contact information</p>

          <div class="mb-4">
            <p class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal">Get in touch with the responsible team</p>
            <div class="mt-6">
              <p class="text-xs xl:text-sm 2xl:text-base font-semibold text-text-800">Technical Support</p>
              <a href="mailto:MARLOSupport@cgiar.org" class="text-[11px] xl:text-sm 2xl:text-base text-primary-300 hover:underline break-all"
                >KDS Team - MARLOSupport@cgiar.org</a
              >
            </div>
          </div>
        </div>
        <!-- Share -->
        <div class="w-full p-4 mb-6 border border-border-light rounded bg-white-100 text-text-300">
          <p class="text-sm xl:text-base 2xl:text-lg font-semibold text-primary-300 mb-4">Share</p>
          <BasicButton
            text="Save to favorites"
            hasIcon
            icon="pi pi-bookmark"
            classList={'w-full justify-center border-primary-300 text-primary-300 mb-2 hover:bg-primary-300 '}
          />
          <div class="mb-2">
            <SocialShare title={innovation.title} className="!mb-0" />
          </div>
          <DownloadImage />
        </div>
      </aside>
    </div>
  </article>
</MainLayout>
