---
export const prerender = true;

import { Image } from 'astro:assets';
import Icon4 from '~/images/icon-4.svg';
import Icon1 from '~/images/icon-1.svg';
import Icon6 from '~/images/icon-6.svg';

import type { GetStaticPaths } from 'astro';
import MainLayout from '@layouts/MainLayout.astro';
import { innovationCatalog } from '~/jsons/innovation-list';
import BasicButton from '~/components/shared/button/BasicButton/BasicButton.component.astro';
import SocialShare from '~/components/shared/SocialShare/SocialShare.component.astro';
import Input from '~/components/shared/input/Input.astro';
import DownloadImage from '~/components/shared/DownloadImage/DownloadImage.component.astro';
import PDFLink from '~/components/shared/PDFLink/PDFLink.component.astro';
import type { Innovation as InnovationComplete } from '~/interfaces/search-complete.interface';
import { getCountryTextStructured } from '~/utils/country-normalize-text/getCountryNormalizeText';
import getReadinessScaleText from '~/utils/readiness-scale/getReadinessScaleText';
import { getActorsByGroup } from '~/utils/actors/getActorsByGroup';
import { useApi } from '~/composables/database-api/useApi';
import CommentCards from './vue/CommentCards.vue';
import CustomToastWrapper from './vue/CustomToastWrapper.vue';
import { texts } from '~/content/texts';
import { phaseId } from '~/content/vars';

interface staticPaths {
  params: { id: string };
  props: { innovation: InnovationComplete };
}

const stats = [
  {
    title: 'Geoscope',
    value: 32,
    imagePath: Icon4,
    quality: 'max'
  },
  {
    title: 'Innovation typology',
    value: 25,
    imagePath: Icon1,
    quality: 'max'
  },
  {
    title: 'Scaling readiness',
    value: 7,
    imagePath: Icon6,
    quality: 'max'
  }
];

(globalThis as any).__innovationCache ??= null;

export const getStaticPaths = (async () => {
  console.log('Building static paths for innovations...');

  // Helper function to fetch innovations with complete data from API at build time
  async function fetchInnovationsComplete(): Promise<InnovationComplete[] | null> {
    try {
      // Use full API URL for build-time fetching (SSG), since no proxy is available during build
      const { getInnovationsComplete } = useApi();
      const response = await getInnovationsComplete({
        phase: phaseId.toString(),
        limit: 1000
      });
      return response.innovations;
    } catch (error) {
      console.warn('Build: API fetch failed, falling back to static data:', error);
      return null;
    }
  }

  // Return cached data if available
  if ((globalThis as any).__innovationCache) {
    console.log('Using cached static paths for innovations');
    return (globalThis as any).__innovationCache;
  }

  try {
    // Try to fetch from API first
    const apiData = await fetchInnovationsComplete();

    if (apiData && apiData.length > 0) {
      console.log(`Building paths from API data: ${apiData.length} innovations`);

      // Create paths directly from complete innovation data (no mapping needed)
      // Filter to ensure all innovations have valid IDs
      const paths = apiData
        .filter(innovation => innovation && innovation.projectInnovationId)
        .map(innovation => {
          console.log(`Building path for innovation ID: ${innovation.projectInnovationId}`);

          return {
            params: { id: innovation.projectInnovationId.toString() },
            props: {
              innovation
            }
          };
        });

      console.log(`Successfully generated ${paths.length} paths`);
      console.log(
        'Generated path IDs:',
        paths.map(p => p.params.id)
      );

      (globalThis as any).__innovationCache = paths; // Cache the successful paths

      return paths;
    }
  } catch (error) {
    console.warn('Failed to fetch from API during build, falling back to static data:', error);
  }

  // Fallback to static data - ensure all innovations have valid IDs
  const fallbackPaths = innovationCatalog
    .filter(innovation => innovation && innovation.id)
    .map(innovation => ({
      params: { id: innovation.id.toString() },
      props: { innovation }
    }));

  console.log(`Using ${fallbackPaths.length} innovations from static fallback data`);
  return fallbackPaths;
}) satisfies GetStaticPaths;

interface Props {
  innovation: InnovationComplete;
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

const { innovation } = Astro.props;

if (!innovation) {
  return Astro.redirect('/404');
}


const countryText = getCountryTextStructured(innovation.countries, innovation.regions, true);

const actorsInfo = getActorsByGroup(innovation.actors);

---

<MainLayout title={innovation.title} description={innovation.narrative}>
  <!-- Mobile: side padding | Desktop (lg+): original layout -->
  <article class="container mx-auto m-auto my-auto px-4 lg:p-0 xl:px-16 2xl:px-20">
    <!-- Return link - Mobile: reduced margin, smaller text | Desktop (lg+): original layout -->
    <a href="/" class="my-6 mb-4 text-primary-300 text-xs font-semibold flex items-center gap-2 hover:underline lg:my-12 lg:mb-8 lg:text-sm xl:text-sm 2xl:text-base">
      <span class="pi pi-arrow-left text-xs lg:text-sm"></span>
      <p>{texts.innovation.goBack}</p>
    </a>

    <!-- Title and main options -->
    <section class="max-width">
      <!-- Mobile: vertical stack on small screens | Desktop (lg+): horizontal with gap -->
      <div class="flex flex-col gap-3 mb-2.5 lg:flex-row lg:flex-wrap lg:items-start lg:justify-between lg:gap-4">
        <!-- Mobile: smaller text, reduced margin | Desktop (lg+): original size -->
        <h1 class="text-sm font-bold mb-2 flex-1 min-w-0 lg:text-base lg:mb-4 xl:text-lg 2xl:text-xl">{innovation.title ?? texts.innovation.innovationDetails.title}</h1>
        <div class="flex flex-wrap gap-2 flex-shrink-0">
          <!--           <BasicButton hasIcon icon="pi pi-bookmark" classList={'bg-white-100 text-primary-300 border border-border-light px-3 py-1 rounded'} /> -->
          <PDFLink id={innovation.projectInnovationId.toString()} isJustIcon className="!border-border-light px-3 py-1 rounded mb-0 !w-[36px]" />
          <SocialShare title={innovation.title} isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
          <DownloadImage isJustIcon className={'!border-border-light px-3 py-1 rounded mb-0 !w-[36px]'} />
        </div>
      </div>
      <!-- Mobile: smaller text, reduced margin | Desktop (lg+): original size -->
      <p class="text-xs font-[400] mb-4 text-text-600 text-justify lg:text-sm lg:mb-6 xl:text-base 2xl:text-lg">{innovation.narrative ?? texts.innovation.innovationDetails.narrative}</p>
    </section>

    <!-- Main Content - Mobile: 1-column stack | Desktop (lg+): original 4-column grid -->
    <div class="grid grid-cols-1 gap-4 mb-8 lg:grid-cols-4 lg:mb-12">
      <!-- Mobile: col-span-1 (full width) | Desktop (lg+): col-span-3 -->
      <section class="col-span-1 lg:col-span-3">
        <!-- Key Metrics - Mobile: reduced padding | Desktop (lg+): original padding -->
        <div class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 lg:p-4 lg:mb-6">
          <p class="text-xs font-semibold text-primary-300 lg:text-sm xl:text-base 2xl:text-lg">{texts.innovation.keymetrics.title}</p>
          <!-- Mobile: flex column stack, reduced gap | Desktop (md+): flex row with gap | Desktop (lg+): justify around with padding -->
          <div class="flex flex-col gap-4 mt-3 lg:flex-row lg:flex-wrap lg:gap-12 lg:mt-4 lg:justify-around lg:px-12 xl:px-24">
            <!-- Geoscope - Mobile: flex-row left-aligned | Desktop (lg+): flex-col centered -->
            <div class="flex flex-row items-center gap-3 lg:flex-col lg:text-center lg:gap-0">
              <div class="w-[32px] h-[32px] mb-0 flex items-center justify-center lg:w-[40px] lg:h-[40px] lg:mb-1">
                {(<Image height="32" quality={stats[0].quality} src={stats[0].imagePath} alt={stats[0].title} class={'pb-1 w-6 h-6 lg:w-8 lg:h-8'} />)}
              </div>
              <div class="flex flex-col items-start lg:items-center">
                <span class="text-[10px] text-primary-300 font-bold lg:text-xs xl:text-xs 2xl:text-sm">{texts.innovation.keymetrics.location}</span>
                <span class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base">
                  {
                    countryText.hasMore ? (
                      <>
                        <span class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base">{countryText.text}</span>
                        <em class="tooltip" tabindex="0" role="tooltip" aria-label={countryText.additionalInfo}>
                          {countryText.additionalText}
                          <span class="tooltiptext">{countryText.additionalInfo}</span>
                        </em>
                      </>
                    ) : (
                      <span class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base">{countryText.text}</span>
                    )
                  }
                </span>
              </div>
            </div>
            <!-- Typology - Mobile: flex-row left-aligned | Desktop (lg+): flex-col centered -->
            <div class="flex flex-row items-center gap-3 lg:flex-col lg:text-center lg:gap-0">
              <div class="w-[32px] h-[32px] mb-0 flex items-center justify-center lg:w-[40px] lg:h-[40px] lg:mb-1">
                {(<Image height="32" quality={stats[1].quality} src={stats[1].imagePath} alt={stats[1].title} class={'pb-1 w-6 h-6 lg:w-8 lg:h-8'} />)}
              </div>
              <div class="flex flex-col items-start lg:items-center">
                <span class="text-[10px] text-primary-300 font-bold lg:text-xs xl:text-xs 2xl:text-sm">{texts.innovation.keymetrics.innovationTypology}</span>
                <span class="text-xs text-text-800 font-normal w-full md:w-[150px] lg:w-[250px] lg:text-xs xl:text-sm 2xl:text-base">{innovation.innovationType?.name || 'N/A'}</span>
              </div>
            </div>
            <!-- Scaling Readiness - Mobile: flex-row left-aligned | Desktop (lg+): flex-col centered -->
            <div class="flex flex-row items-center gap-3 lg:flex-col lg:text-center lg:gap-0">
              <div class="w-[32px] h-[32px] mb-0 flex items-center justify-center lg:w-[40px] lg:h-[40px] lg:mb-1">
                {(<Image height="32" quality={stats[2].quality} src={stats[2].imagePath} alt={stats[2].title} class={'pb-1 w-6 h-6 lg:w-8 lg:h-8'} />)}
              </div>
              <div class="flex flex-col items-start lg:items-center">
                <span class="text-[10px] text-primary-300 font-bold lg:text-xs xl:text-xs 2xl:text-sm">{texts.innovation.keymetrics.scalingReadiness}</span>
                <span class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base"
                  >{getReadinessScaleText(innovation.readinessScale).textComplet}</span
                >
              </div>
            </div>
          </div>
        </div>
        <!-- Description - Mobile: reduced padding | Desktop (lg+): original padding -->
        <div class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 lg:p-4 lg:mb-6">
          <!-- Adapted and scaled context / What needs to be adapted? -->
          {
            innovation.reasonKnowledgePotential == null || innovation.reasonKnowledgePotential === '' ? (
              <></>
            ) : (
              <>
                <p class="text-xs font-semibold text-primary-300 mt-3 lg:text-sm lg:mt-4 xl:text-base 2xl:text-lg">{texts.innovation.reasonKnowledgePotential}</p>
                <p class="text-xs text-text-800 font-normal mt-2 text-justify lg:text-xs xl:text-sm 2xl:text-base">
                  {innovation.reasonKnowledgePotential}
                </p>
              </>
            )
          }
          <!-- Expected outcomes - Mobile: smaller text | Desktop (lg+): original size -->
          <p class="text-xs font-semibold text-primary-300 mt-3 lg:text-sm xl:text-base 2xl:text-lg">{texts.innovation.knowledgeResultsNarrative}</p>
            <p class="text-xs text-text-900 font-normal mt-2 text-justify lg:text-xs xl:text-sm 2xl:text-base">
            {
              innovation.knowledgeResultsNarrative == null || innovation.knowledgeResultsNarrative === '' ? (
              <span class="text-gray-500">{texts.innovation.defaultValue}</span>
              ) : (
              innovation.knowledgeResultsNarrative
              )
            }
            </p>
          <!-- Intended beneficiaries/users -->
          <p class="text-xs font-semibold text-primary-300 mt-3 lg:text-sm lg:mt-4 xl:text-base 2xl:text-lg">{texts.innovation.beneficiariesNarrative}</p>
          <p class="text-xs text-text-800 font-normal mt-2 text-justify lg:text-xs xl:text-sm 2xl:text-base">
            {
              innovation.beneficiariesNarrative == null || innovation.beneficiariesNarrative === '' ? (
                <span class="text-gray-500">{texts.innovation.defaultValue}</span>
              ) : (
                innovation.beneficiariesNarrative
              )
            }
          </p>
          <!-- Bundle innovations -->
          {innovation.bundles != null && innovation.bundles.length > 0 && (
          <>
            <p class="text-xs font-semibold text-primary-300 mt-3 lg:text-sm lg:mt-4 xl:text-base 2xl:text-lg">{texts.innovation.bundles.title}</p>
            <p class="text-xs text-text-800 w-max font-normal mt-2 lg:text-xs xl:text-sm 2xl:text-base">
            <div class="w-full pb-1">
              {innovation.bundles.map(bundle => (
                <div class="mb-2">
                  <div class="inline-flex items-center gap-1 border-1 border-[#439255] bg-[#F7F7F7] rounded-full px-2 text-[#439255]">
                  {
                    (bundle.selectedInnovationReadinessScale !== null || bundle.selectedInnovationReadinessScale !== "") ? (
                    <svg height="10" viewBox="0 0 15 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                      fill-rule="evenodd"
                      clip-rule="evenodd"
                      d="M2.2557 7.24802C2.06283 7.40936 1.80123 7.5 1.52847 7.5C1.2557 7.5 0.994106 7.40936 0.801231 7.24802C0.608356 7.08668 0.5 6.86785 0.5 6.63968C0.5 6.41151 0.608356 6.19269 0.801231 6.03135L4.22721 3.16636L4.2344 3.16034C4.51432 2.93101 4.89053 2.80256 5.28234 2.80256C5.67416 2.80256 6.05037 2.93101 6.33028 3.16034L6.33748 3.16636L8.08593 4.62895L10.4984 2.49483L9.42939 1.60059C9.32171 1.51041 9.2484 1.39555 9.21871 1.27053C9.18902 1.14551 9.20428 1.01594 9.26258 0.898171C9.32087 0.780405 9.41957 0.67973 9.54623 0.608862C9.67288 0.537994 9.8218 0.500112 9.97417 0.5H13.7291C13.9335 0.5 14.1296 0.567942 14.2742 0.688881C14.4188 0.809819 14.5 0.973847 14.5 1.14488V4.28501C14.4999 4.41247 14.4546 4.53705 14.3699 4.64299C14.2851 4.74894 14.1648 4.83151 14.024 4.88027C13.8832 4.92903 13.7283 4.9418 13.5789 4.91696C13.4294 4.89213 13.2921 4.8308 13.1843 4.74073L11.9529 3.71064L9.17344 6.17064L9.14569 6.19386C8.86577 6.42319 8.48956 6.55164 8.09775 6.55164C7.70594 6.55164 7.32973 6.42319 7.04981 6.19386L7.04262 6.18784L5.28183 4.71579L2.2557 7.24802Z"
                      fill="#439255" />
                    </svg>
                    <span class="text-sm">{bundle.selectedInnovationReadinessScale ? bundle.selectedInnovationReadinessScale - 1 : texts.innovation.bundles.external}</span>
                    ) : <span class="text-sm">{texts.innovation.bundles.external}</span>
                  }
                </div>
                <span class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal ml-2">{bundle.selectedInnovationName}</span>
              </div>
              ))}
              </div>
            </p>
          </>
          )}
          <!-- Piece of evidence -->
          <p class="text-xs font-semibold text-primary-300 mt-3 lg:text-sm lg:mt-4 xl:text-base 2xl:text-lg">{texts.innovation.evidence.title}</p>
          <p class="text-xs text-text-800 font-normal mt-2 lg:text-xs xl:text-sm 2xl:text-base">
            {
              innovation.references == null || innovation.references.length === 0 ? (
                <span class="text-gray-500">{texts.innovation.defaultValue}</span>
              ) : (
                <ul class="pl-4">
                  {
                  innovation.references.map(reference => 
                    reference.hasEvidenceByDeliverable ? (
                      <li class="py-1 list-disc">
                        <p class="text-sm font-normal">{reference.deliverableName ? reference.deliverableName : texts.innovation.evidence.reference.deliverableName}</p>
                        <a class="text-xs text-text-500 underline text-primary-500 font-semibold" href={reference.disseminationUrl ? reference.disseminationUrl : "#"}>{reference.disseminationUrl ? reference.disseminationUrl : texts.innovation.evidence.reference.link}</a>
                      </li>
                    ) : (
                      <li class="py-1 list-disc">
                        <p class="text-sm font-normal">{reference.reference ? reference.reference : texts.innovation.evidence.reference.reference}</p>
                        <a class="text-xs text-text-500 underline text-primary-500 font-semibold" href={reference.link ? reference.link : "#"}>{reference.link ? reference.link : texts.innovation.evidence.reference.link}</a>
                      </li>
                    )
                  )
                }
                </ul>
              )
            }
          </p>
        </div>
        <!-- Community solution stories - Mobile: reduced padding | Desktop (lg+): original padding -->
        <section class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 relative lg:p-4 lg:mb-6">
          <p class="text-xs font-semibold text-primary-300 mb-3 lg:text-sm lg:mb-4 xl:text-base 2xl:text-lg">{texts.innovation.communitySolutionStories.title}</p>

          <!-- Comment stories -->
          <div data-comment-cards>
            <CommentCards innovationId={innovation.projectInnovationId} client:load />
          </div>
          
          <!-- Input container -->
          <form class="mt-4 lg:mt-6" id="community-story-form" data-innovation-id={innovation.projectInnovationId}>
            <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.communitySolutionStories.form.prompt}</p>
            <!-- Content Form - Mobile: no left margin | Desktop (lg+): original margin -->
            <div class="mt-2 flex flex-col gap-1 lg:ml-4">
              <!-- Name Input -->
              <Input
                label={texts.innovation.communitySolutionStories.form.name.label}
                placeholder={texts.innovation.communitySolutionStories.form.name.placeholder}
                id="name-input"
                name="name-input"
                required
              />
              <!-- E-mail Input -->
              <Input
                label={texts.innovation.communitySolutionStories.form.email.label}
                placeholder={texts.innovation.communitySolutionStories.form.email.placeholder}
                id="email-input"
                name="email-input"
                type="email"
                required
              />
              <!-- Comment Input -->
               <Input
                label={texts.innovation.communitySolutionStories.form.comment.label}
                placeholder={texts.innovation.communitySolutionStories.form.comment.placeholder}
                id="story-input"
                name="story-input"
                hasMaxLength
                maxLength={50}
                required
              />

              <!-- Submit Button with CAPTCHA - Mobile: vertical stack | Desktop (sm+): horizontal -->
              <div class="flex flex-col gap-3 mt-4 sm:flex-row sm:items-center sm:justify-end sm:gap-2">
                <!-- Cloudflare Turnstile CAPTCHA -->
                <div
                  class="cf-turnstile"
                  data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}
                  data-theme="light"
                ></div>
                <BasicButton
                  text={texts.innovation.communitySolutionStories.form.send}
                  type="submit"
                  classList="!bg-lime-500 text-white px-8 py-2.5 rounded hover:!bg-lime-800 transition-colors duration-300 sm:px-10 sm:py-3"
                />
              </div>
          </form>
        </section>
      </section>
      <!-- Aside Sidebar - Mobile: col-span-1 (full width), order first | Desktop (lg+): col-span-1, order last -->
      <aside class="col-span-1 order-first lg:order-last">
        <!-- Download PDF button - Mobile: reduced bottom margin | Desktop (lg+): original margin -->
        <PDFLink id={innovation.projectInnovationId.toString()} className="w-full mb-4 lg:mb-6" />
        <!-- Quick Information - Mobile: reduced padding | Desktop (lg+): original padding -->
        <div class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 lg:p-4 lg:mb-6">
          <p class="text-xs font-semibold text-primary-300 mb-3 lg:text-sm lg:mb-4 xl:text-base 2xl:text-lg">{texts.innovation.aside.title}</p>

          <div class="mb-3 lg:mb-4">
            <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.aside.leadOrganization}</p>
            {
              innovation.contactPersons && innovation.contactPersons.length > 0 ? (
                <p class="text-xs xl:text-sm 2xl:text-base text-gray-600 font-normal">{innovation.contactPersons[0].institutionAcronym ? innovation.contactPersons[0].institutionAcronym + ' - ' : ''}{innovation.contactPersons[0].institutionName}</p>
              ) : (
                <p class="text-xs xl:text-sm 2xl:text-base text-gray-600 font-normal">{texts.innovation.defaultValue}</p>
              )
            }
          </div>
          <!-- Key actors -->
          <div class="mb-3 lg:mb-4">
            <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.aside.keyActors}</p>
            
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-1">
                {
                  actorsInfo.length > 0 ? (
                    actorsInfo.map(actor => (
                        <div class="relative tooltip not-underline flex items-center justify-center">
                          <Image
                          src={actor.imgUrl}
                          alt={Array.isArray(actor.actorInfoName) ? actor.actorInfoName.join(', ') : (actor.actorInfoName || 'Actor Icon')}
                          quality={'max'}
                          class="w-full"
                          />
                          <span class="tooltiptext hidden md:block">
                              {Array.isArray(actor.actorInfoName) ? actor.actorInfoName.map(name => (
                                <ul class="flex flex-col items-baseline ">
                                  <li class="text-white text-[12px] font-normal list-disc list-inside pl-4">{name}</li>
                                </ul>
                              )) : <p class="text-[12px]">{actor.actorInfoName}</p>}
                          </span>
                          <div class="md:hidden bg-white border border-border-light rounded shadow-md p-2 absolute left-1/2 transform -translate-x-1/2 top-[75%] w-full whitespace-normal break-words z-10">
                            <ul>
                              {Array.isArray(actor.actorInfoName) ? actor.actorInfoName.map(name => (
                                <li class="text-[8px] text-text-800 font-normal list-disc list-inside">{name}</li>
                              )) : <p class="text-[8px]">{actor.actorInfoName}</p>}
                            </ul>
                          </div>
                      </div>
                    ))
                  ) : (
                    <ul class="pl-2 col-span-3">
                      <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">{texts.innovation.defaultValue}</li>
                    </ul>
                  )
                }
              </div>
          </div>
          <!-- Key organizations -->
          <div>
            <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.aside.keyOrganizations}</p>
            <ul class="pl-2">
              {
                innovation.contributingOrganizations && innovation.contributingOrganizations.length > 0 ? (
                  innovation.contributingOrganizations.map(org => (
                    <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">
                      {org.city ? org.city + ' - ' : ''}
                      {org.institutionAcronym ? org.institutionAcronym + ' - ' : ''}
                      {org.institutionName}
                      </li>
                  ))
                ) : (
                  <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">{texts.innovation.defaultValue}</li>
                )
              }
            </ul>
          </div>
          <!-- SDGs: Sustainable Development Goals contribution -->
          <div class="mt-3 lg:mt-4">
            <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base mb-2">{texts.innovation.aside.sdgs}</p>
              {
                innovation.sdgs && innovation.sdgs.length > 0 ? (
                  <div class="grid grid-cols-4 lg:grid-cols-3 gap-2">
                    {innovation.sdgs.sort((a, b) => a.sdgId - b.sdgId).map(sdg => (
                      sdg.sdgId && (
                        <img 
                          src={`https://marlo-pdf-resources-dev.s3.us-east-1.amazonaws.com/sdg/E-WEB-Goal-${sdg.sdgId}.png`}
                          alt={sdg.sdgShortName}
                          class="w-full h-auto object-contain"
                        />
                      )
                    ))}
                  </div>) : (
                  <ul>
                    <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">{texts.innovation.defaultValue}</li>
                  </ul>
                )
              }
          </div>
        </div>
        <!-- Contact information - Mobile: reduced padding | Desktop (lg+): original padding -->
        <div class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 lg:p-4 lg:mb-6">
          <p class="text-xs font-semibold text-primary-300 mb-2 lg:text-sm xl:text-base 2xl:text-lg">{texts.innovation.aside.contactInformation.title}</p>

          <div class="mb-2">
            <p class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.aside.contactInformation.subtitle}</p>
            <ul>
              {
                innovation.contactPersons && innovation.contactPersons.length > 0 ? (
                  innovation.contactPersons.map(contact =>
                    contact.contactPersons && contact.contactPersons.length > 0 ? (
                      contact.contactPersons.map(person => (
                        <>
                          <li class="text-xs xl:text-sm 2xl:text-base text-text-800 font-normal list-disc list-inside">
                            {person.userName} -{' '}
                            <a class="underline text-primary-500" href={`mailto:${person.userEmail}`}>
                              {person.userEmail}
                            </a>
                          </li>
                        </>
                      ))
                    ) : (
                      <span class="text-xs xl:text-sm 2xl:text-base">{texts.innovation.defaultValue}</span>
                    )
                  )
                ) : (
                  <span class="text-xs xl:text-sm 2xl:text-base">{texts.innovation.defaultValue}</span>
                )
              }
            </ul>
            <div class="mt-2">
              <p class="text-xs font-semibold text-text-800 lg:text-xs xl:text-sm 2xl:text-base">{texts.innovation.aside.contactInformation.technicalSupport}</p>
              <p class="text-xs text-text-800 font-normal lg:text-xs xl:text-sm 2xl:text-base">
                {texts.innovation.aside.contactInformation.technicalSupportDescription}
              </p>
              <a
                href="mailto:MARLOSupport@cgiar.org"
                class="text-[11px] xl:text-sm 2xl:text-base text-primary-500 underline hover:underline break-all">{texts.innovation.aside.contactInformation.technicalSupportEmail}</a
              >
            </div>
          </div>
        </div>
        <!-- Share - Mobile: reduced padding | Desktop (lg+): original padding -->
        <div class="w-full p-3 mb-4 border border-border-light rounded-xl bg-white-100 text-text-300 lg:p-4 lg:mb-6">
          <p class="text-xs font-semibold text-primary-300 mb-3 lg:text-sm lg:mb-4 xl:text-base 2xl:text-lg">{texts.innovation.aside.share}</p>
          <!--           <BasicButton
            text="Save to favorites"
            hasIcon
            icon="pi pi-bookmark"
            classList={'w-full justify-center border-primary-300 text-primary-300 mb-2 hover:bg-primary-300 '}
          /> -->
          <div class="mb-2">
            <SocialShare title={innovation.title} className="!mb-0" />
          </div>
          <DownloadImage />
        </div>
      </aside>
    </div>
  </article>
  <CustomToastWrapper client:load />
</MainLayout>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  import { useApi } from '~/composables/database-api/useApi';

  // Only initialize once
  if (!(window as any).__formInitialized) {
    (window as any).__formInitialized = true;

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('community-story-form') as HTMLFormElement;
      
      if (!form) return;

      form.addEventListener('submit', async function (event) {
        event.preventDefault();
        event.stopPropagation();

        const innovationId = form.getAttribute('data-innovation-id');
        const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

        // Get Turnstile token
        const turnstileResponse = (window as any).turnstile?.getResponse?.();

        if (!turnstileResponse) {
          alert('Please complete the CAPTCHA verification');
          return;
        }

        // Show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = 'Sending...';
        }

        const formData = new FormData(form);
        const commentData = {
          user_name: formData.get('name-input')?.toString() || '',
          user_lastname: '',
          user_email: formData.get('email-input')?.toString() || '',
          comment: formData.get('story-input')?.toString() || '',
          innovation_id: Number(innovationId || 0),
          modification_justification: 'User submitted community story'
        };

        // Submit the comment data with CAPTCHA token
        // Disable CAPTCHA verification for now
          try {
          // Verify Turnstile token with Cloudflare
          const turnstileSecretKey = import.meta.env.PUBLIC_TURNSTILE_SECRET_KEY;
          if (turnstileSecretKey) {
            const verifyUrl = 'https://challenges.cloudflare.com/turnstile/v0/siteverify';
            const verifyResponse = await fetch(verifyUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                secret: turnstileSecretKey,
                response: turnstileResponse
              })
            });
            const verifyResult = await verifyResponse.json();
            if (!verifyResult.success) {
              throw new Error('Turnstile verification failed');
            }
          }

          // Submit directly to backend API
          const { postInnovationComment } = useApi();
          await postInnovationComment(commentData);

          (globalThis as any).onUseToast?.({ severity: 'success', summary: 'Success', detail: 'Your story has been submitted successfully.', life: 8000 });
          form.reset();
          (window as any).turnstile?.reset?.();
          
          // Dispatch custom event to refresh comments
          window.dispatchEvent(new CustomEvent('refresh-comments'));
          console.log('Refresh event dispatched');
        } catch (error) {
          
          (globalThis as any).onUseToast?.({ severity: 'error', summary: 'Error', detail: 'Failed to submit. ' + error, life: 8000 });
          (window as any).turnstile?.reset?.();
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Send';
          }
        }

      });
    });
  }
</script>
