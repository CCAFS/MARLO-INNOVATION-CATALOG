---
import { Image } from 'astro:assets';

import BgImgSolutionStories from '~/images/bg_img_solution_stories.png';
import { useApi } from '~/composables/database-api/useApi';
import EmptyDataImg from '~/images/empty-data.png';


const solutionStories = [
  {
    id: 1,
    author: "Jhon Doe",
    date: "22 Jul 2024",
    rating: 0.62,
    content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation",
    innovation: "The Community of Practices of Institutions creates an environment for...",
    readMoreLink: "#"
  },
  {
    id: 2,
    author: "Jane Smith",
    date: "18 Jul 2024",
    rating: 0.75,
    content: "Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis.",
    innovation: "Digital Innovation Platform for Agricultural Solutions transforms...",
    readMoreLink: "#"
  }
];

let fetchedStories: {
          id: number;
          innovation_id: number;
          innovation_name: string;
          user_name: string;
          user_lastname: string;
          user_email: string;
          comment: string;
          is_active: boolean;
          active_since: string;
          modification_justification: string;
        }[] | [] | undefined = [];

const getCommunityStories = async () => {
  // Placeholder for fetching stories from an API
  try {
    const { getCommunityStories } = useApi();
  const response = await getCommunityStories({ limit: 2 });
    if (response) {
      return response;
    }
  } catch (error) {
    
  }
};

fetchedStories = await getCommunityStories();

---

<!-- Mobile: altura automática | Desktop (lg+): altura fija original -->
<div class="relative w-full h-auto min-h-[400px] overflow-hidden lg:h-112 2xl:h-128">
  <!-- Background with opacity - separate layer -->
  <div
    class="absolute inset-0 bg-cover bg-center opacity-20"
    style={`background-image: url(${BgImgSolutionStories.src});`}>
  </div>

  <!-- Mobile: padding lateral | Desktop (xlg+): diseño original -->
  <div class="relative z-10 h-full flex flex-col justify-start items-center container mx-auto px-4 pt-8 pb-8 lg:p-4 lg:pt-4 xl:px-8 2xl:px-12 md:!pt-20">
    <div class="w-full mx-auto">
      <!-- Mobile: texto más pequeño, margin bottom reducido | Desktop (lg+): tamaño original -->
      <h1 class="text-sm font-bold text-[#1E1E1E] mb-4 text-left lg:text-base lg:mb-8 xl:text-lg 2xl:text-xl">Solution Stories</h1>
    </div>

    <!-- Mobile: 1 columna, gap reducido | Desktop (md+): 2 columnas, gap original -->
    <div class="grid grid-cols-1 gap-4 w-full md:grid-cols-2 md:gap-6">
        {fetchedStories && fetchedStories.length > 0 ? (
          fetchedStories.map((story) => (
            <!-- Mobile: padding reducido | Desktop (lg+): padding original -->
            <article class="story-card bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300 w-full lg:p-6">
              <!-- Card Header -->
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <!-- Mobile: stack vertical en pantallas muy pequeñas | Desktop: horizontal -->
                  <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:gap-1">
                    <span class="text-xs font-bold text-gray-900 sm:text-sm">{story.user_name} {story.user_lastname}</span>
                    <div class="w-0.5 h-0.5 bg-gray-500 rounded-full mx-3 hidden sm:block"></div>
                    <span class="text-xs text-gray-500 sm:text-sm">{new Date(story.active_since).toLocaleDateString('en-GB', {
                          day: '2-digit',
                          month: 'short',
                          year: 'numeric'
                        })}</span>
                  </div>
                </div>
              </div>

              <!-- Content -->
              <div>
                <p class="text-xs text-gray-700 leading-relaxed line-clamp-3 sm:text-sm">
                  {story.comment}
                </p>
              </div>

              <!-- Innovation Title -->
              <div class="mb-4 mt-2">
                <p class="text-xs text-gray-600 line-clamp-1 sm:text-sm">
                  <span class="font-semibold">Innovation:</span> {story.innovation_name ? story.innovation_name : 'N/A'}
                </p>
              </div>

              <!-- Read More Link -->
              <div class="flex justify-end">
                <a
                  href={`/innovation/${story.innovation_id}`}
                  class="text-xs text-blue-600 hover:text-blue-700 font-medium transition-colors duration-200 sm:text-sm">
                  Read More
                </a>
              </div>
            </article>
          ))
        ) : (
          <div class="col-span-full flex flex-col items-center justify-center py-8 bg-white rounded-lg shadow-md lg:py-12">
            {(<Image height={100} quality="max" src={EmptyDataImg} alt="No Community Stories" class={'pb-1 w-16 h-auto lg:w-auto'} />)}
            <p class="text-gray-500 text-base mb-2 lg:text-lg">No solution stories available</p>
            <p class="text-gray-400 text-xs lg:text-sm">Check back later for new stories</p>
          </div>
        )}
    </div>
  </div>
</div>
