---
import { Image } from 'astro:assets';

import BgImgSolutionStories from '~/images/bg_img_solution_stories.png';
import { useApi } from '~/composables/database-api/useApi';
import EmptyDataImg from '~/images/empty-data.png';


const solutionStories = [
  {
    id: 1,
    author: "Jhon Doe",
    date: "22 Jul 2024",
    rating: 0.62,
    content: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation",
    innovation: "The Community of Practices of Institutions creates an environment for...",
    readMoreLink: "#"
  },
  {
    id: 2,
    author: "Jane Smith",
    date: "18 Jul 2024",
    rating: 0.75,
    content: "Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis.",
    innovation: "Digital Innovation Platform for Agricultural Solutions transforms...",
    readMoreLink: "#"
  }
];

let fetchedStories: {
          id: number;
          innovation_id: number;
          innovation_name: string;
          user_name: string;
          user_lastname: string;
          user_email: string;
          comment: string;
          is_active: boolean;
          active_since: string;
          modification_justification: string;
        }[] | [] | undefined = [];

const getCommunityStories = async () => {
  // Placeholder for fetching stories from an API
  try {
    const { getCommunityStories } = useApi();
  const response = await getCommunityStories({ limit: 2 });
    if (response) {
      return response;
    }
  } catch (error) {
    
  }
};

fetchedStories = await getCommunityStories();

---

<div class="relative w-full h-112 2xl:h-128 overflow-hidden">
  <!-- Background with opacity - separate layer -->
  <div 
    class="absolute inset-0 bg-cover bg-center opacity-20" 
    style={`background-image: url(${BgImgSolutionStories.src});`}>
  </div>
  
  <!-- Content layer - full opacity -->
  <div class="relative z-10 h-full flex flex-col justify-start items-center container mx-auto p-0 xl:px-16 2xl:px-20 pt-4 md:!pt-20">
    <div class="w-full mx-auto px-4 md:px-0">
      <h1 class="text-base xl:text-lg 2xl:text-xl font-bold text-[#1E1E1E] mb-8 text-left">Solution Stories</h1>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 px-4 md:px-0 gap-6 w-full">
        {fetchedStories && fetchedStories.length > 0 ? (
          fetchedStories.map((story) => (
            <article class="story-card bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300 w-full">
              <!-- Card Header -->
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="flex flex-row items-center gap-1">
                    <span class="text-sm font-bold text-gray-900">{story.user_name} {story.user_lastname}</span>
                    <div class="w-0.5 h-0.5 bg-gray-500 rounded-full mx-3"></div>
                    <span class="text-sm text-gray-500">{new Date(story.active_since).toLocaleDateString('en-GB', {
                          day: '2-digit', 
                          month: 'short', 
                          year: 'numeric' 
                        })}</span>
                  </div>
                </div>
              </div>

              <!-- Content -->
              <div >
                <p class="text-sm text-gray-700 leading-relaxed line-clamp-3">
                  {story.comment}
                </p>
              </div>
              
              <!-- Innovation Title -->
              <div class="mb-4">
                <p class="text-sm text-gray-600 line-clamp-1">
                  <span class="font-semibold">Innovation:</span> {story.innovation_name ? story.innovation_name : 'N/A'}
                </p>
              </div>

              <!-- Read More Link -->
              <div class="flex justify-end">
                <a 
                  href={`/innovation/${story.innovation_id}`}
                  class="text-sm text-blue-600 hover:text-blue-700 font-medium transition-colors duration-200">
                  Read More
                </a>
              </div>
            </article>
          ))
        ) : (
          <div class="col-span-full flex flex-col items-center justify-center py-12 bg-white rounded-lg shadow-md">
            {(<Image height={100} quality="max" src={EmptyDataImg} alt="No Community Stories" class={'pb-1'} />)}
            <p class="text-gray-500 text-lg mb-2">No solution stories available</p>
            <p class="text-gray-400 text-sm">Check back later for new stories</p>
          </div>
        )}
    </div>
  </div>
</div>
