---
import BasicButton from '../button/BasicButton/BasicButton.component.astro';

interface Props {
  url?: string;
  title?: string;
  isJustIcon?: boolean;
  className?: string;
}

const { isJustIcon, className } = Astro.props;
---

<download-image class="download-image-container group relative overflow-visible">
  <BasicButton
    {...isJustIcon ? {} : { text: 'Download jpg' }}
    hasIcon
    icon="pi pi-image"
    classList={`w-full justify-center !border-accent-500 !text-accent-500 mb-2 hover:!bg-accent-500 hover:!text-white cursor-pointer ${className}`}
  />
</download-image>

<script>
  import { domToBlob } from 'modern-screenshot';

  class DownloadImage extends HTMLElement {
    connectedCallback() {
      const btnDownload = this.querySelector('button');
      if (btnDownload) {
        document.addEventListener('DOMContentLoaded', () => {
          const downloadBtn = btnDownload as HTMLButtonElement | null;
          if (downloadBtn) {
            downloadBtn.addEventListener('click', async () => {
              try {
                // Show loading state (optional)
                downloadBtn.disabled = true;

                // Get the screenshot area container
                const screenshotArea = document.querySelector('#screenshot-area') as HTMLElement;
                const bodyElement = document.querySelector('body') as HTMLElement;

                if (!screenshotArea || !bodyElement) {
                  throw new Error('Screenshot area not found');
                }

                // Store original styles
                const originalBodyOverflow = bodyElement.style.overflow;
                const originalBodyHeight = bodyElement.style.height;
                const originalBodyMinHeight = bodyElement.style.minHeight;

                // Apply temporary styles to prevent extra whitespace
                bodyElement.style.overflow = 'hidden';
                bodyElement.style.height = 'auto';
                bodyElement.style.minHeight = 'auto';

                // Get scale factor for high-DPI screens
                const scale = window.devicePixelRatio || 1;

                // Capture only the screenshot area
                const dataUrl = await domToBlob(screenshotArea, {
                  width: screenshotArea.offsetWidth * scale,
                  height: screenshotArea.offsetHeight * scale,
                  style: {
                    transform: `scale(${scale})`,
                    transformOrigin: 'top left',
                    width: `${screenshotArea.offsetWidth}px`,
                    height: `${screenshotArea.offsetHeight}px`
                  },
                  features: {
                    // Remove extra whitespace and control characters
                    removeControlCharacter: true
                  }
                }).then(blob => {
                  return URL.createObjectURL(blob);
                });

                // Restore original styles
                bodyElement.style.overflow = originalBodyOverflow;
                bodyElement.style.height = originalBodyHeight;
                bodyElement.style.minHeight = originalBodyMinHeight;

                // Create download link
                const link = document.createElement('a');
                link.download = `innovation-${Date.now()}.jpg`;
                link.href = dataUrl;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
              } catch (error) {
                console.error('Screenshot failed:', error);
                alert('Failed to generate screenshot');
              } finally {
                // Reset button state
                downloadBtn.disabled = false;
              }
            });
          }
        });
      }
    }
  }

  customElements.define('download-image', DownloadImage);
</script>
