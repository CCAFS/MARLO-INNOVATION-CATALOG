---
import getSharingLink from '~/utils/share-link/getSharingLink';
import BasicButton from '../button/BasicButton/BasicButton.component.astro';

interface Props {
  url?: string;
  title?: string;
  isJustIcon?: boolean;
  className?: string;
}

const { url, title, isJustIcon, className } = Astro.props;

// Get the current page URL - use pathname only to construct on client side
const sharePath = url || Astro.url.pathname;
const shareTitle = title || 'Check out this innovation';
---

<div class="social-share-container group relative overflow-visible" data-share-path={sharePath} data-share-title={shareTitle}>
  <BasicButton
    {...isJustIcon ? {} : { text: 'Share to social network' }}
    hasIcon
    icon="pi pi-share-alt"
    classList={`w-full justify-center border-accent-300 !text-accent-300 mb-2 hover:!bg-accent-300 hover:!text-white cursor-pointer ${className}`}
  />
  <!-- Dropdown wrapper with padding to bridge the gap -->
  <div class={`dropdown-wrapper hidden group-hover:block absolute top-full w-full pt-1 z-10`}>
    <div
      class={`social-share-dropdown bg-white border border-border-light rounded-lg shadow-lg ${isJustIcon ? 'w-max absolute right-0' : 'overflow-hidden w-full'}`}>
      <!-- LinkedIn -->
      <a
        href="#"
        data-network="linkedin"
        class="share-link flex items-center gap-3 px-4 py-3 text-xs text-text-800 hover:bg-gray-50 transition-colors duration-200">
        <i class="pi pi-linkedin text-[#0A66C2] text-base"></i>
        <span>Share on LinkedIn</span>
      </a>

      <!-- Facebook -->
      <a
        href="#"
        data-network="facebook"
        class="share-link flex items-center gap-3 px-4 py-3 text-xs text-text-800 hover:bg-gray-50 transition-colors duration-200 border-t border-border-light">
        <i class="pi pi-facebook text-[#1877F2] text-base"></i>
        <span>Share on Facebook</span>
      </a>

      <!-- Twitter/X -->
      <a
        href="#"
        data-network="twitter"
        class="share-link flex items-center gap-3 px-4 py-3 text-xs text-text-800 hover:bg-gray-50 transition-colors duration-200 border-t border-border-light">
        <i class="pi pi-twitter text-[#000000] text-base"></i>
        <span>Share on X (Twitter)</span>
      </a>

      <!-- Copy Link -->
      <button
        type="button"
        class="copy-link-btn w-full flex items-center gap-3 px-4 py-3 text-xs text-text-800 hover:bg-gray-50 transition-colors duration-200 border-t border-border-light text-left">
        <i class="pi pi-link text-accent-300 text-base"></i>
        <span class="copy-link-text">Copy hyperlink</span>
      </button>
    </div>
  </div>
</div>

<script>
  import getSharingLink from '~/utils/share-link/getSharingLink';

  document.addEventListener('DOMContentLoaded', () => {
    // Get the actual current URL from the browser
    const currentUrl = window.location.href;

    console.log('ðŸ” Social Share Debug - Current Location:', {
      href: window.location.href,
      origin: window.location.origin,
      pathname: window.location.pathname
    });

    // Update all share links with the correct URL
    document.querySelectorAll('.social-share-container').forEach(container => {
      const sharePath = container.getAttribute('data-share-path') || '';
      const shareTitle = container.getAttribute('data-share-title') || 'Check out this innovation';

      // Construct full URL - use sharePath if it's already a full URL, otherwise combine with origin
      const shareUrl = sharePath.startsWith('http') ? sharePath : `${window.location.origin}${sharePath}`;

      console.log('ðŸ“ Constructed Share URL:', {
        sharePath,
        shareUrl,
        isFullUrl: sharePath.startsWith('http')
      });

      // Update social share links
      container.querySelectorAll('.share-link').forEach(link => {
        const network = link.getAttribute('data-network') as 'linkedin' | 'facebook' | 'twitter';

        const shareParams: any = { url: shareUrl, network };
        if (network === 'twitter') {
          shareParams.title = shareTitle;
          shareParams.hashtags = 'Innovation,Research,AICCRA';
        }

        const shareLink = getSharingLink(shareParams);
        link.setAttribute('href', shareLink);

        console.log(`ðŸ”— ${network.toUpperCase()} link:`, shareLink);
      });

      // Update copy link button
      const copyButton = container.querySelector('.copy-link-btn');
      if (copyButton) {
        console.log('ðŸ“‹ Copy link URL:', shareUrl);

        copyButton.addEventListener('click', async e => {
          e.preventDefault();
          const textSpan = copyButton.querySelector('.copy-link-text');

          if (textSpan) {
            try {
              await navigator.clipboard.writeText(shareUrl);
              const originalText = textSpan.textContent;
              textSpan.textContent = 'Copied!';
              console.log('âœ… Copied to clipboard:', shareUrl);

              setTimeout(() => {
                textSpan.textContent = originalText;
              }, 2000);
            } catch (err) {
              console.error('âŒ Failed to copy:', err);
              textSpan.textContent = 'Failed to copy';
              setTimeout(() => {
                textSpan.textContent = 'Copy hyperlink';
              }, 2000);
            }
          }
        });
      }
    });
  });
</script>

<style>
  .social-share-container {
    position: relative;
  }

  .dropdown-wrapper {
    min-width: 100%;
  }

  /* Ensure dropdown stays visible on hover - the wrapper includes padding to bridge the gap */
  .social-share-container:hover .dropdown-wrapper,
  .dropdown-wrapper:hover {
    display: block;
  }
</style>
